<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
			PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
			"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="ticketing">

	<!-- 지역 맵-->
	<resultMap class="locationVo" id="locationMap">
		<result property="location_name" column="CINEMA_LOCATION"/>
		<result property="cinema_count" column="CINEMA_COUNT"/>
	</resultMap>
	
	<!-- 영화관 맵 -->
	<resultMap class="cinemaVo" id="cinemaMap">
		<result property="cinema_code" column="CINEMA_CODE"/>
		<result property="cinema_name" column="CINEMA_NAME"/>
		<result property="cinema_location" column="CINEMA_LOCATION"/>
	</resultMap>
	
	<!-- 영화 맵 -->
	<resultMap class="movieVo" id="movieMap">
		<result property="movie_code" column="MOVIE_CODE"/>
		<result property="movie_title" column="MOVIE_TITLE"/>
		<result property="movie_spectator" column="MOVIE_SPECTATOR"/>
	</resultMap>
	
	<!-- 상영일정 맵 -->
	<resultMap class="screenVo" id="screenMap">
		<result property="screen_code" column="SCREEN_CODE"/>
		<result property="movie_title" column="MOVIE_TITLE"/>
		<result property="movie_spectator" column="MOVIE_SPECTATOR"/>
		<result property="screen_date" column="SCREEN_DATE"/>
		<result property="screen_time" column="SCREEN_TIME"/>
		<result property="theater_seat_num" column="THEATER_SEAT_NUM"/>
		<result property="theater_name" column="THEATER_NAME"/>
		<result property="cur_seat" column="CUR_SEAT"/>	
	</resultMap>
	
	<!-- 영화정보 맵 -->
	<resultMap class="movieInfoVo" id="movieInfoMap">
		<result property="movie_title" column="MOVIE_TITLE"/>
		<result property="screen_date" column="SCREEN_DATE"/>
		<result property="screen_time" column="SCREEN_TIME"/>
		<result property="end_time" column="END_TIME"/>
		<result property="cinema_name" column="CINEMA_NAME"/>
		<result property="theater_name" column="THEATER_NAME"/>
		<result property="movie_spectator" column="MOVIE_SPECTATOR"/>
	</resultMap>
	
			
	<!-- 지역 리스트 반환 -->
	<select id="getLocationList" resultMap="locationMap">
		SELECT DISTINCT CINEMA_LOCATION, COUNT(*) AS CINEMA_COUNT
		FROM   CINEMA
		GROUP BY CINEMA_LOCATION
		ORDER BY CINEMA_LOCATION
	</select>
	
	<!-- 영화관 리스트 반환 -->
	<select id="getCinemaList" resultMap="cinemaMap">
		SELECT CINEMA_CODE
			,  CINEMA_NAME
			,  CINEMA_LOCATION
		FROM   CINEMA
		ORDER BY CINEMA_LOCATION, CINEMA_NAME
	</select>
	
	<!-- 모든 영화 리스트 반환 -->
	<select id="getAllMovieList" resultMap="movieMap">
		SELECT MOVIE_CODE
			,  MOVIE_TITLE
			,  MOVIE_SPECTATOR
		FROM MOVIE
		ORDER BY MOVIE_TITLE
	</select>
	
	<!-- 영화관 지점에 상영하는 영화 리스트 반환 -->
	<select id="findMovieListByCinemaName" parameterClass="String" resultMap="movieMap">
		SELECT DISTINCT m.movie_title, m.movie_code, m.movie_spectator
		FROM screen s 
        	INNER JOIN theater th ON s.theater_code = th.theater_code
        	INNER JOIN cinema c ON th.cinema_code = c.cinema_code
        	INNER JOIN movie m ON s.movie_code = m.movie_code
		WHERE c.cinema_name = #cinema_name#
	</select>
	
	<!-- 영화관 지점의 상영시간 리스트 반환 -->
	<select id="findAllScreenListByCinemaName" resultMap="screenMap">
		SELECT sc.screen_code
		    ,  m.movie_title
		    ,  m.movie_spectator
		    , sc.screen_date
		    , sc.screen_time
		    , th.theater_seat_num
		    , th.theater_name,
		    (
		      SELECT 156 - count(*)
		      FROM screen s INNER JOIN movie_ticket mt ON s.screen_code = mt.screen_code 
		      WHERE mt.mt_status = '선택가능' AND s.screen_code = sc.screen_code
		     ) cur_seat    
		FROM screen sc 
		              INNER JOIN theater th ON sc.theater_code = th.theater_code
		              INNER JOIN cinema c ON th.cinema_code = c.cinema_code
		              INNER JOIN movie m on sc.movie_code = m.movie_code
		WHERE c.cinema_name = #cinema_name# and sc.screen_date = #screen_date#
		ORDER BY m.movie_title		
	</select>

	<!-- 선택한 영화의 정보 반환-->
	<select id="getMovieInfoByScreenCode" parameterClass="String" resultMap="movieInfoMap">
		SELECT m.movie_title
			,  s.screen_date
			,  s.screen_time
			,  TO_TIMESTAMP(TO_CHAR(screen_time + (.000694 * m.movie_runtime), 'YYYY-MM-DD HH24:MI'),
                            'YYYY-MM-DD HH24:MI:SS') as END_TIME
			,  c.cinema_name
			,  th.theater_name
			,  m.movie_spectator
		FROM screen s 
     		 INNER JOIN movie m ON s.movie_code = m.movie_code
     		 INNER JOIN theater th ON s.theater_code = th.theater_code
     		 INNER JOIN cinema c ON th.cinema_code = c.cinema_code
		WHERE s.screen_code = #screen_code#
	</select>
	
	<!-- 선택한 영화 예매-->
	<insert id="insertTickting" parameterClass="ticketingVo">
		<selectKey keyProperty="ticket_num" resultClass="int">
			SELECT TICKET_NUM_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO TICKETING(TICKET_NUM
							, TICKET_DATE
							, TICKET_CNT
							, TICKET_PRICE
							, MEM_CODE
							, SCREEN_CODE)
        VALUES(TICKET_NUM_SEQ.NEXTVAL
             , #ticket_date#
             , #ticket_cnt#
             , #ticket_price#
             , #mem_code#
             , #screen_code#)
	</insert>
	
	<!-- 영화표 생성 -->
	<insert id="insertMovieTicket" parameterClass="ticketingVo">
			
	</insert>
</sqlMap>			





